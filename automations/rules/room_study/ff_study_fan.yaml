---
# ## Fan Before Bed
alias: Turn on study fan when hot
trigger:
  - platform: numeric_state
    entity_id: sensor.ff_study_sensor_temperature
    above: 22
    for:
      minutes: 10

  - platform: time
    at: '21:00:00'

  - platform: state
    entity_id: switch.occ_room_study
    from: 'off'
    to: 'on'
    
condition:
  condition: and
  conditions:
    # I'm awake
    - condition: numeric_state
      entity_id: sensor.family_family_state_raw
      below: 8

    # Someone is home
    - condition: state
      entity_id: group.people_family
      state: 'home'

    # The room is occupied
    - condition: state
      entity_id: switch.occ_room_study
      state: 'on'

    # The room is too hot
    - condition: numeric_state
      entity_id: sensor.ff_study_sensor_temperature
      above: 22

action:
    - service: switch.turn_on
      data:
        entity_id: switch.ff_study_fan
      
    - service: script.notify_join
      data_template:
        who: "stuart"
        title: 'Too Hot'
        notification_id: "hass-parking-his"
        value1: "I've turned on the study fan"